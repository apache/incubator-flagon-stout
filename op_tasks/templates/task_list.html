{% extends "userpage.html" %}

{% block content %}

<h1><b>Task List</b></h1>

<!-- progress bar -->
{% if user.userprofile.experiment.show_progress %}
<h2><b>Status</b></h2>
<div class="progress">
   <div class="progress-bar" role="progressbar" aria-valuenow="60" 
      aria-valuemin="0" aria-valuemax="100" style="min-width: 2em; width: {{user.userprofile.progress}}%;">
      {{user.userprofile.progress}}% Complete
   </div>
</div>
{% endif %}

<!-- instructions -->
<div class="instructions" >
  <a href="{% url 'op_tasks:instruct' %}">
    {% if not user.userprofile.read_instructions %}
      <div class="task-current">
        <h3>
          <span class="glyphicon glyphicon-unchecked"></span>
          Click here to review instructional materials
        </h3>
      </div>
    {% else %}
      <h3>
        <span class="glyphicon glyphicon-check"></span>
        Click here to review instructional materials
      </h3>
      <p class="text">This material is available throughout the experiment</p>
    {% endif %}
  </a>
</div>

<!-- task list table -->
<table class="ot-list table table-bordered">
  <tbody>
    {% for task in userprofile.tasklistitem_set.all %}
    <!-- task not active, complete, and exit complete -->
      {% if task.task_complete and not task.task_active and task.exit_complete %}
        <tr class="ot-disabled">
          <td class="status">
            <span class="glyphicon glyphicon-check"></span>
          </td>
          <td>
            <div style="font-size: 18px;">
              <span class="heading">{{task.op_task.name}} with {{task.product.name}}</span>
              <span class="pull-right text">Task Complete. Thank You!</span>
            </div>     
          </td>
        </tr>
        <!-- task not active, complete, and exit active -->
      {% elif task.task_complete and not task.task_active and not task.exit_complete %}
        <tr class="task-current">
          <td class="status">
            <span class="glyphicon glyphicon-unchecked"></span>
          </td>   
          <td>
            <div class="task-current">
              <h3 class="heading disabled">{{task.op_task.name}} with {{task.product.name}}</h3>
              <p class="text disabled">Task Complete. Thank You!</p>
              <a href="" data-toggle="modal" data-target="#exit-{{task.pk}}">
                <span class="glyphicon glyphicon-hand-right"></span>
                Complete Post-Task Survey to Continue
              </a>
            </div>
          </td>
        </tr>
        <!-- task active and complete with exit active -->
      {% elif task.task_complete and task.task_active and task.exit_active and not task.exit_complete %}
        <tr>
          <td class="status" >
            <span class="glyphicon glyphicon-check" style="color:#428bca"></span>
          </td>
          <td>
            <a href="{% url 'op_tasks:product' task_pk=task.pk %}">
              <h3 class="heading">{{task.op_task.name}} with {{task.product.name}}</h3>
              <p class="text">Task Complete.  Thank you!</p>
            <a class="task-current" href="" data-toggle="modal" data-target="#exit-{{task.pk}}">
              <span class="glyphicon glyphicon-hand-right"></span>
              Complete Post-Task Survey Here
            </a>
          </td>
        </tr>
        <!-- task active, complete, exit complete -->
      {% elif task.task_active and task.task_complete and task.exit_complete %}
        <tr>
          <td class="status">
            <span class="glyphicon glyphicon-check" style="color:#428bca"></span>
          </td>
          <td>
            <a href="{% url 'op_tasks:product' task_pk=task.pk %}">
              <h3 class="heading">{{task.op_task.name}} with {{task.product.name}}</h3>
              <p class="text">Task Complete.  Thank you!</p>
            <a href="" data-toggle="modal" data-target="#exit-{{task.pk}}">
              <span class="glyphicon glyphicon-check"></span>
              Post-task survey complete
            </a>
          </td>
        </tr>
        <!-- task active, not complete and exit task not active -->
      {% elif task.task_active and not task.task_complete %}
        <tr class="task-current">
          <td class="status">
            <span class="glyphicon glyphicon-unchecked"></span>
          </td>   
          <td>
            <a class="task-current" href="{% url 'op_tasks:product' task_pk=task.pk %}">
              <h3 class="heading">{{task.op_task.name}} with {{task.product.name}}</h3>
              <p class="text">Task not yet completed. Click to start this Operational Task</p>
            </a>
          </td>
        </tr>
        <!-- task not active and not complete -->
      {% elif not task.task_complete and not task.task_active %}
        <tr class="ot-disabled">
          <td class="status">
            <span class="glyphicon glyphicon-unchecked"></span>
          </td>
          <td>
            <div style="font-size: 18px;">
              <span class="heading">{{task.op_task.name}} with {{task.product.name}}</span>
              <span class="pull-right text">Complete previous tasks first.</span>
            </div>      
          </td>
        </tr>
      {% endif %}

      <!-- exit survey popup -->
      <div class="modal fade" id="exit-{{task.pk}}" tabindex="-1" role="dialog" aria-labelledby="intake" aria-hidden="true">
        <div class="modal-dialog" width="940px" height="540px">
          <div class="modal-content">
            <div class="modal-body" id="surveymonkeyframe">
              <iframe src="{{task.op_task.exit_url}}?sid={{userprofile.user_hash}}" width="1100px" height="500px"></iframe>
            </div>
            <div class="modal-footer">
              <div>
                <button type="button" style="float: left;" class="btn btn-primary" data-dismiss="modal">Hide</button>
              </div>
              <div>
                <form id="exit-survey-complete" method="post" action="{% url 'op_tasks:product' task_pk=task.pk %}">{% csrf_token %}
                  <button type="submit" style="float: right;" class="btn btn-success">Submit survey</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

    {% endfor %}

  </tbody>
</table>


{% if all_complete %}
  <hr>
  <h4>Thank you for participating, you have completed all Operational Tasks!</h4>
  <p>If you are interested in future study components or engagement with analytic tools, 
    we will contact you if you indicated such interest in the intake questionnaire.</p>
  <p>If you are interested in working on developing these analytic tools, which are free 
    and open source, please see the DARPA <a href="http://www.darpa.mil/opencatalog/XDATA.html">open catalogue.</a> </p>
{% endif %}
{% endblock %}